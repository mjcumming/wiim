# WiiM Home Assistant Integration - Development Rules

## Documentation

- **Developer Guide**: See `/development/README.md` for architecture and contribution guidelines
- **Testing Guide**: See `/development/TESTING.md` for test requirements and examples
- **HA Integration Guide**: See `/development/HA_INTEGRATION_GUIDE.md` for Home Assistant specific patterns (references upstream guides)
- **User Documentation**: See `/docs/` for user-facing guides

**Do not create new documentation files without being explicitly asked.**

**Always reference upstream pywiim documentation** (see "Reference Upstream Documentation" section below) instead of duplicating content.

## CRITICAL: Never Work Around pywiim Issues

**NEVER create workarounds or fallbacks in the HA integration for missing pywiim functionality.**

If pywiim is not providing something it should (like EQ capabilities, available presets, etc.):

1. **FIX IT IN PYWIIM** - Go fix the pywiim library directly
2. **DO NOT** add fallback detection logic in the HA integration
3. **DO NOT** add conditional checks for "if pywiim doesn't provide X, try Y"
4. **DO NOT** work around pywiim bugs with HA integration code

### Why This Matters

- pywiim is THE source of truth for device capabilities
- Working around pywiim issues creates technical debt
- Fixes belong in pywiim so ALL users benefit
- The HA integration should be a thin wrapper, not compensating for pywiim

### Examples of What NOT To Do

❌ **WRONG:**

```python
def _is_eq_supported(self) -> bool:
    # Check capabilities first
    if capabilities.get("supports_eq"):
        return True
    # Fallback: check if player has presets (WORKAROUND)
    if player.available_eq_presets:
        return True
```

✅ **RIGHT:**

```python
def _is_eq_supported(self) -> bool:
    # pywiim MUST provide this via capabilities
    return capabilities.get("supports_eq", False)
```

If pywiim doesn't set `supports_eq` correctly → **FIX PYWIIM**

### When You Discover a pywiim Issue

1. Document it clearly
2. Create a test case that demonstrates the issue
3. Fix it in pywiim
4. Update pywiim dependency version
5. Remove any temporary workarounds from HA integration

## Reference Upstream Documentation

**ALWAYS reference upstream pywiim documentation guides instead of duplicating content.**

When working with pywiim integration patterns or API usage:

1. **Reference** `/development/HA_INTEGRATION_GUIDE.md` for Home Assistant integration patterns
2. **Reference** the upstream [HA Integration Guide](https://github.com/mjcumming/pywiim/blob/main/docs/integration/HA_INTEGRATION.md) for detailed patterns
3. **Reference** the upstream [API Reference](https://github.com/mjcumming/pywiim/blob/main/docs/integration/API_REFERENCE.md) for API documentation
4. **DO NOT** duplicate upstream documentation content in this repository
5. **DO NOT** create local copies of upstream guides (they become stale)

**When pywiim version is updated:**

1. **Update** the review date in `/development/HA_INTEGRATION_GUIDE.md`
2. **Update** the pywiim version tracked in that file (if documented)
3. **Check** if upstream guides have changed and note any breaking changes
4. **Update** `manifest.json` with the new minimum pywiim version requirement
5. **Document** in CHANGELOG.md the pywiim version update

**Why:**

- Upstream documentation is maintained alongside library changes
- Prevents documentation drift and stale information
- Single source of truth reduces maintenance burden
- Version tracking ensures compatibility awareness

## File Naming Conventions

- No underscores in directory or file names
- Use hyphens for multi-word names: `eq-detection.md`, not `eq_detection.md`
- Document files: YYYY.MM.DD format preferred

## Home Assistant Automation Style

- One automation per file
- No dash before `id` field (avoid `- id:`)

## Project Structure

- Core functionality in `/custom_components/wiim/`
- Tests in `/tests/` with proper fixtures
- Documentation in `/docs/`
- Keep integration simple - complexity belongs in pywiim

## Logging Philosophy

- Use appropriate log levels:
  - DEBUG: Normal operation details
  - INFO: State changes, setup completion
  - WARNING: Recoverable issues, deprecated features
  - ERROR: Actual problems requiring attention
- Include device name in log messages: `[Device Name] message`
- Log pywiim capability detection results for debugging

## Testing Requirements

- **CRITICAL: Always add tests for new code** - Codecov requires 77.88% patch coverage
  - Every new function, method, or feature must have corresponding tests
  - Every code change must include tests for the modified functionality
  - Codecov will fail if new/changed code lacks test coverage
  - Patch coverage (new code) is separate from project coverage (overall)
- Test pywiim integration, not device hardware
- Mock pywiim Player and Client objects
- Test error handling and edge cases
- No integration tests that require actual hardware
- When adding new code:
  1. Write the code
  2. Write tests for the new code immediately
  3. Ensure all new lines are covered by tests
  4. Run `pytest --cov` to verify coverage before committing

## Code Quality

- Type hints required
- Docstrings for public methods
- Follow Home Assistant development guidelines
- Keep methods focused and single-purpose

## Documentation Files

**CRITICAL: Do not create documentation files unless explicitly requested or needed for long-term reference.**

### Documentation Rules

1. **Do NOT create "progress" or "summary" files**

   - ❌ No "TEST-SUITE-SUMMARY.md", "COVERAGE-PROGRESS.md", "FINAL-SUMMARY.md"
   - ❌ No "look what I did" documentation
   - ❌ No temporary status files
   - ❌ No session summaries
   - ✅ Update existing documentation instead

2. **Only create documentation when:**

   - ✅ Explicitly requested by user
   - ✅ Needed for long-term reference (architecture, rules, guides)
   - ✅ Replacing/consolidating existing documentation
   - ✅ User-facing documentation (user guides, FAQs)

3. **Update existing files instead:**

   - ✅ Update `tests/README.md` with test info
   - ✅ Update `docs/TESTING-CONSOLIDATED.md` with testing strategy
   - ✅ Update `docs/ARCHITECTURE.md` with architecture changes
   - ✅ Update `docs/DEVELOPMENT-RULES.md` with new rules

4. **Use Git for progress tracking:**

   - ✅ Git commits for progress
   - ✅ Test output for status (`pytest --cov`)
   - ✅ CI/CD reports for coverage
   - ❌ Don't create files for status updates

5. **Documentation structure:**
   - `/docs/` - User and developer documentation (long-term reference only)
   - `/tests/README.md` - Test quick reference only
   - `/development/` - Developer guides
   - Code comments and docstrings - Inline documentation

### When to Create vs Update

**Create new file only if:**

- It's a completely new topic not covered elsewhere
- User explicitly requests it
- It's replacing multiple redundant files

**Update existing file if:**

- Information belongs in an existing document
- It's a status update or progress report
- It's temporary or session-specific information

**Examples:**

- ❌ Creating `TEST-SUITE-COMPLETE.md` when `tests/README.md` exists
- ✅ Updating `tests/README.md` with new test information
- ❌ Creating `COVERAGE-PROGRESS.md` for status updates
- ✅ Running `pytest --cov` to see coverage (no file needed)
- ❌ Creating `FINAL-SUMMARY.md` for session summary
- ✅ Using git commits and test results for progress tracking

**See `docs/DOCUMENTATION-GUIDELINES.md` and `docs/DOCUMENTATION-BEST-PRACTICES.md` for detailed guidance.**

## Dependencies

- pywiim is the ONLY library for WiiM device communication
- Use Home Assistant's shared aiohttp session
- No direct device HTTP calls - always through pywiim

## pywiim API Usage

Always use pywiim's actual attribute names:

### EQ Control

- **Capability**: `capabilities.get("supports_eq")` (NOT "eq_supported")
- **Presets list**: `player.eq_presets` (NOT "available_eq_presets")
- **Current preset**: `player.eq_preset`
- **Set preset**: `await player.set_eq_preset(name.lower())`

### Group/Multiroom

**Device API = Source of Truth:**

- **Check group state**: `player.is_master`, `player.is_slave`, `player.is_solo` (booleans)
- **Role string**: `player.role` ("master"/"slave"/"solo")
- **Get slave info**: `await player.client.get_device_group_info()`

**Group object = Player references for operations:**

- `player.group.master` - Player object reference to master
- `player.group.slaves` - list[Player] for operations
- `player.group.all_players` - list[Player] for operations
- **WARNING**: These require `player_finder` callback to be populated!

**How to check if device has slaves:**

- ✅ Check `player.is_master` (boolean, preferred)
- ✅ Check `player.role == "master"` (string alternative)
- ❌ DO NOT check `len(player.group.all_players) > 1` (requires player_finder)

**Enable group operations:**

- ✅ Provide `player_finder` callback when creating Player
- This allows pywiim to link Player objects into `group.all_players`

### Common Mistakes to Avoid

❌ `player.available_eq_presets` - Does not exist
❌ `capabilities.get("eq_supported")` - Wrong key name
❌ `player.group.slaves` - Exists but not populated, use `all_players` instead
✅ `player.eq_presets` - Correct
✅ `capabilities.get("supports_eq")` - Correct
✅ `player.group.all_players` - Correct

## When to Update This File

- When asked to remember something important
- When architectural decisions are made
- When patterns are established
- When bugs reveal design issues

**If asked to remember something, update this file or the appropriate documentation immediately.**
