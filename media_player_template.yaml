template:
  - trigger:
      - platform: time_pattern
        seconds: "/1"
    sensor:
      - name: "Master Bedroom Real Time Elapsed"
        unit_of_measurement: "s"
        state: >
          {% set player = 'media_player.master_bedroom' %}
          {% if is_state(player, 'playing') %}
            {% set duration = state_attr(player, 'media_duration') %}
            {% set position = state_attr(player, 'media_position') %}
            {% set updated_at = state_attr(player, 'media_position_updated_at') %}
            {% if duration is not none and position is not none and updated_at is not none %}
              {{ (position + (now() - updated_at).total_seconds()) | round(0) }}
            {% else %}
              0
            {% endif %}
          {% else %}
            {{ state_attr(player, 'media_position') or 0 }}
          {% endif %}
      - name: "Master Bedroom Progress Percentage"
        unit_of_measurement: "%"
        state: >
          {% set player = 'media_player.master_bedroom' %}
          {% if is_state(player, 'playing') %}
            {% set duration = state_attr(player, 'media_duration') %}
            {% if duration is not none and duration > 0 %}
              {% set position = state_attr(player, 'media_position') %}
              {% set updated_at = state_attr(player, 'media_position_updated_at') %}
              {% if position is not none and updated_at is not none %}
                {% set elapsed = position + (now() - updated_at).total_seconds() %}
                {{ [0, (elapsed / duration * 100), 100] | sort | last | round(1) }}
              {% else %}
                0
              {% endif %}
            {% else %}
              0
            {% endif %}
          {% elif is_state(player, 'paused') %}
            {% set duration = state_attr(player, 'media_duration') %}
            {% if duration is not none and duration > 0 %}
              {% set position = state_attr(player, 'media_position') %}
              {{ (position / duration * 100) | round(1) }}
            {% else %}
              0
            {% endif %}
          {% else %}
            0
          {% endif %}
